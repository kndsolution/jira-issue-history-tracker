
<div class="mod-header">
    <form class="aui">
        <p>
            <aui-label for="async-product-single-select">Search User:</aui-label>
            <aui-select
                        id="issue-tab-panel-user-selector"
                        name="product"
                        placeholder="Select a product"
                        src="products"
                        value="type to trigger async"
            >
            #foreach ($user in $this.findUsers(''))
                <aui-option value="$user.getKey()">$issueTabPanelUtil.getUserWikiRender($user.getKey())</aui-option>
            #end
            </aui-select>
            <aui-label for="async-product-single-select">Search Field:</aui-label>
            <aui-select
                        id="issue-tab-panel-field-selector"
                        name="product"
                        placeholder="Select a product"
                        src="products"
                        value="type to trigger async"
            >
            #foreach ($field in $this.findFields())
                <aui-option value="$field.getName()">$field.getName()</aui-option>
            #end
            </aui-select>
        </p>
    </form>
    <form class="aui">
            <p>

            </p>
        </form>
    <table class="aui aui-table-sortable" id="issue-tab-panel-result-table">
        <thead>
            <tr>
                <th id="updated-date">Updated Date</th>
                <th  class="aui-table-column-unsortable" id="updated-user">Updated User</th>
                <th  class="aui-table-column-unsortable" id="element">Field</th>
                <th  class="aui-table-column-unsortable" id="before">Before</th>
                <th  class="aui-table-column-unsortable" id="after">After</th>
            </tr>
        </thead>
        <tbody>
            #foreach ($changeHistory in $changeHistories)
                #set($historyItems = $changeHistory.getChangeItems())
                #foreach ($historyItem in $historyItems)
                <tr>
                    <td headers="updated-date"><time datetime="$issueTabPanelUtil.convertDate($changeHistory.getTimePerformed())">$issueTabPanelUtil.convertDate($changeHistory.getTimePerformed())</td>
                    <td headers="updated-user" value="$changeHistory.getAuthorKey()">$renderer.render("[~$issueTabPanelUtil.getUserWikiRender($changeHistory.getAuthorKey())]", null)</td>
                    <td headers="updated-field" value="$historyItem.get("field")">$historyItem.get("field")</td>
                    <td headers="before" value=$!historyItem.get("oldvalue") >$!historyItem.get("oldstring")</td>
                    <td headers="after" value=$!historyItem.get("newvalue")>$!historyItem.get("newstring")</td>
                </tr>
                #end
            #end
        </tbody>
    </table>
</div>

<script>
AJS.tablessortable.setTableSortable(AJS.$(".aui-table-sortable"));

AJS.$('#issue-tab-panel-user-selector').on('change',function(e){
    let selectedUser = e.target.value;
    for( let user of AJS.$('#issue-tab-panel-result-table > tbody > tr > td[headers="updated-user"]')) {
        let trUser = AJS.$(user);
        if(selectedUser == user.getAttribute('value')){
            trUser.parent().show();
        }
        else{
            trUser.parent().hide();
        }
    }
});

AJS.$('#issue-tab-panel-field-selector').on('change',function(e){
    let selectedField = e.target.value;
    for( let field of AJS.$('#issue-tab-panel-result-table > tbody > tr > td[headers="updated-field"]')) {
        let trField = AJS.$(field);
        if(selectedField.toLowerCase() == field.getAttribute('value').toLowerCase()){
            trField.parent().show();
            console.log("Show search field : ", selectedField);
            console.log("Show field : ", field.getAttribute('value'));
        }
        else{
            trField.parent().hide();
            console.log("Hide search field : ", selectedField);
            console.log("Hide field : ", field.getAttribute('value'));
        }
    }
});
</script>
